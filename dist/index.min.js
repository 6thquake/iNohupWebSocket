!function(e,n){"function"==typeof define&&define.amd?define([],n):"object"==typeof exports?module.exports=n():e.NohupWebSocket=n()}(this,function(){function e(e,n){var t=document.createEvent("CustomEvent");return t.initCustomEvent(e,!1,!1,n),t}function n(e,n){e.addEventListener("open",function(e){n.onopen(e)}),e.addEventListener("close",function(e){n.onclose(e)}),e.addEventListener("connecting",function(e){n.onconnecting(e)}),e.addEventListener("message",function(e){n.onmessage(e)}),e.addEventListener("error",function(e){n.onerror(e)})}function t(o,i,a){var c={debug:!1,automaticOpen:!0,timeoutInterval:2e3,maxReconnectAttempts:null,binaryType:"blob"};a||(a={});for(var s in c)"undefined"!=typeof a[s]?this[s]=a[s]:this[s]=c[s];this.url=o,this.reconnectAttempts=0,this.readyState=WebSocket.CONNECTING,this.protocol=null;var r,u=this,d=!1,p=document.createElement("div"),b=new Karn({maxWaitTime:u.maxReconnectWaitTime,base:u.reconnectBaseTime});this.sendMap={},this.subMap={},n(p,u),this.addEventListener=p.addEventListener.bind(p),this.removeEventListener=p.removeEventListener.bind(p),this.dispatchEvent=p.dispatchEvent.bind(p),b.run=this.open=function(n){r=new WebSocket(u.url,i||[]),r.binaryType=this.binaryType,n||(p.dispatchEvent(e("connecting")),this.reconnectAttempts=0),(u.debug||t.debugAll)&&console.debug("NohupWebSocket","attempt-connect",u.url),r.onopen=function(o){(u.debug||t.debugAll)&&console.debug("NohupWebSocket","onopen",u.url),u.protocol=r.protocol,u.readyState=WebSocket.OPEN,u.reconnectAttempts=0;var i=e("open");i.isReconnect=n,n=!1,p.dispatchEvent(i)},r.onclose=function(n){if(r=null,d)u.readyState=WebSocket.CLOSED,p.dispatchEvent(e("close"));else{u.readyState=WebSocket.CONNECTING;var t=e("connecting");t.code=n.code,t.reason=n.reason,t.wasClean=n.wasClean,p.dispatchEvent(t),b.execute(!0)}},r.onmessage=function(n){(u.debug||t.debugAll)&&console.debug("NohupWebSocket","onmessage",u.url,n.data);var o=e("message");o.data=n.data,p.dispatchEvent(o)},r.onerror=function(n){(u.debug||t.debugAll)&&console.debug("NohupWebSocket","onerror",u.url,n),p.dispatchEvent(e("error"))}},1==this.automaticOpen&&this.open(!1),this.send=function(e){if(r){(u.debug||t.debugAll)&&console.debug("NohupWebSocket","send",u.url,e);var n=JSON.stringify(e),o=Q.defer();return r.send(n),u.sendMap[n]=o,o.promise}throw"INVALID_STATE_ERR : Pausing to reconnect websocket"},this.sub=function(e){var n=JSON.stringify(e),t=Q.defer(),o=u.subMap[n];return o?o.push(t):u.subMap[n]=[t],t.promise},this.close=function(e,n){"undefined"==typeof e&&(e=1e3),r&&r.close(e,n)},this.refresh=function(){r&&r.close()}}return t.prototype.onopen=function(e){},t.prototype.onclose=function(e){},t.prototype.onconnecting=function(e){},t.prototype.onmessage=function(e){var n=e.data,t=this;if(n){n=JSON.parse(n);var o=JSON.stringify(n.request),i=t.sendMap[o],a=t.subMap[o];i&&i.notify(n),a&&a.forEach(function(e){e.notify(n)})}},t.prototype.onerror=function(e){},t.debugAll=!1,t.CONNECTING=WebSocket.CONNECTING,t.OPEN=WebSocket.OPEN,t.CLOSING=WebSocket.CLOSING,t.CLOSED=WebSocket.CLOSED,t.getInstance=function(e,n,o){return t.instance||(t.instance=new t(e,n,o)),t.instance},t});