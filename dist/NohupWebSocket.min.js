!function(e,n){"function"==typeof define&&define.amd?define(["q"],n):"object"==typeof exports?module.exports=n(require("q")):e.NohupWebSocket=n(e.Q)}(this,function(e){function n(e){var n={maxWaitTime:30,run:function(){this.execute()},base:2,exponential:0};e&&"object"==typeof e&&(Number(e.base)==e.base&&e.base>0&&(n.base=e.base),Number(e.exponential)==e.exponential&&e.exponential>0&&(n.exponential=e.exponential),Number(e.maxWaitTime)==e.maxWaitTime&&e.maxWaitTime>0&&(n.maxWaitTime=e.maxWaitTime),"function"==typeof e.run&&(n.run=e.run));for(var t in n)this[t]=n[t]}function t(e,n){var t=document.createEvent("CustomEvent");return t.initCustomEvent(e,!1,!1,n),t}function o(e,n){e.addEventListener("open",function(e){n.onopen(e)}),e.addEventListener("close",function(e){n.onclose(e)}),e.addEventListener("connecting",function(e){n.onconnecting(e)}),e.addEventListener("message",function(e){n.onmessage(e)}),e.addEventListener("error",function(e){n.onerror(e)})}function i(e,r,a){var s={debug:!1,automaticOpen:!0,timeoutInterval:2e3,maxReconnectAttempts:null,binaryType:"blob"};a||(a={});for(var c in s)"undefined"!=typeof a[c]?this[c]=a[c]:this[c]=s[c];this.url=e,this.reconnectAttempts=0,this.readyState=WebSocket.CONNECTING,this.protocol=null;var u,p=this,d=!1,f=document.createElement("div"),b=new n({maxWaitTime:p.maxReconnectWaitTime,base:p.reconnectBaseTime});this.sendMap={},this.subMap={},o(f,p),this.addEventListener=f.addEventListener.bind(f),this.removeEventListener=f.removeEventListener.bind(f),this.dispatchEvent=f.dispatchEvent.bind(f),b.run=this.open=function(e){u=new WebSocket(p.url,r||[]),u.binaryType=this.binaryType,e||(f.dispatchEvent(t("connecting")),this.reconnectAttempts=0),(p.debug||i.debugAll)&&console.debug("NohupWebSocket","attempt-connect",p.url),u.onopen=function(n){b.reset(),(p.debug||i.debugAll)&&console.debug("NohupWebSocket","onopen",p.url),p.protocol=u.protocol,p.readyState=WebSocket.OPEN,p.reconnectAttempts=0;var o=t("open");o.isReconnect=e,e=!1,f.dispatchEvent(o)},u.onclose=function(e){if(u=null,d)p.readyState=WebSocket.CLOSED,f.dispatchEvent(t("close"));else{p.readyState=WebSocket.CONNECTING;var n=t("connecting");n.code=e.code,n.reason=e.reason,n.wasClean=e.wasClean,f.dispatchEvent(n),b.execute(!0)}},u.onmessage=function(e){(p.debug||i.debugAll)&&console.debug("NohupWebSocket","onmessage",p.url,e.data);var n=t("message");n.data=e.data,f.dispatchEvent(n);var o=e.data;o&&(o=JSON.parse(o),o&&("pong"==o.data||o.request&&"ping"==o.request.url)&&p.pong())},u.onerror=function(e){(p.debug||i.debugAll)&&console.debug("NohupWebSocket","onerror",p.url,e),f.dispatchEvent(t("error"))}},1==this.automaticOpen&&this.open(!1),this.send=function(e){if(u){(p.debug||i.debugAll)&&console.debug("NohupWebSocket","send",p.url,e);var n=JSON.stringify(e),t=Q.defer();return u.send(n),p.sendMap[n]=t,t.promise}throw"INVALID_STATE_ERR : Pausing to reconnect websocket"},this.sub=function(e){var n=JSON.stringify(e),t=Q.defer(),o=p.subMap[n];return o?o.push(t):p.subMap[n]=[t],t.promise},this.pong=function(){this.send({url:"pong"})},this.close=function(e,n){"undefined"==typeof e&&(e=1e3),u&&u.close(e,n)},this.refresh=function(){u&&u.close()}}var r,a=!1;return n.prototype.reset=function(){this.exponential=0,a=!1},n.prototype.execute=function(){var e=function(e,n,t){var o;return a?t:(o=Math.pow(e,n),o>=t&&(o=t,a=!0),o)};return function(){var n=this,t=arguments;clearTimeout(r);var o=1e3*e(n.base,n.exponential++,n.maxWaitTime);r=setTimeout(function(){n.run(t)},o)}}(),i.prototype.onopen=function(e){},i.prototype.onclose=function(e){},i.prototype.onconnecting=function(e){},i.prototype.onmessage=function(e){var n=e.data,t=this;if(n){n=JSON.parse(n);var o=JSON.stringify(n.request),i=t.sendMap[o],r=t.subMap[o];i&&i.notify(n),r&&r.forEach(function(e){e.notify(n)})}},i.prototype.onerror=function(e){},i.debugAll=!1,i.CONNECTING=WebSocket.CONNECTING,i.OPEN=WebSocket.OPEN,i.CLOSING=WebSocket.CLOSING,i.CLOSED=WebSocket.CLOSED,i.getInstance=function(e,n,t){return i.instance||(i.instance=new i(e,n,t)),i.instance},i});