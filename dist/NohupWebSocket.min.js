!function(e,t){"function"==typeof define&&define.amd?define(["q"],t):"object"==typeof exports?module.exports=t(require("q")):e.NohupWebSocket=t(e.Q)}(this,function(e){function t(e){var t={maxWaitTime:30,run:function(){this.execute()},base:2,exponential:0};e&&"object"==typeof e&&(Number(e.base)==e.base&&e.base>0&&(t.base=e.base),Number(e.exponential)==e.exponential&&e.exponential>0&&(t.exponential=e.exponential),Number(e.maxWaitTime)==e.maxWaitTime&&e.maxWaitTime>0&&(t.maxWaitTime=e.maxWaitTime),"function"==typeof e.run&&(t.run=e.run));for(var n in t)this[n]=t[n]}function n(e,t){var n=document.createEvent("CustomEvent");return n.initCustomEvent(e,!1,!1,t),n}function o(e,t){e.addEventListener("open",function(e){t.onopen(e)}),e.addEventListener("close",function(e){t.onclose(e)}),e.addEventListener("connecting",function(e){t.onconnecting(e)}),e.addEventListener("message",function(e){t.onmessage(e)}),e.addEventListener("error",function(e){t.onerror(e)})}function i(e){return"string"==typeof e||e instanceof String}function r(e){var t=e;if(!t)return null;i(t)&&(t={url:t}),t.method||(t.method="GET");var n=null;return n=t.url?["strict:",t.method.toUpperCase(),":",t.url.split("?")[0]].join(""):JSON.stringify(t)}function a(i,s,u){var c={debug:!1,automaticOpen:!0,timeoutInterval:2e3,maxReconnectAttempts:null,binaryType:"blob"};u||(u={});for(var p in c)"undefined"!=typeof u[p]?this[p]=u[p]:this[p]=c[p];this.url=i,this.reconnectAttempts=0,this.readyState=WebSocket.CONNECTING,this.protocol=null;var l,d=this,f=!1,b=document.createElement("div"),h=new t({maxWaitTime:d.maxReconnectWaitTime,base:d.reconnectBaseTime});this.sendMap={},this.subMap={},this.patternMap={},o(b,d),this.addEventListener=b.addEventListener.bind(b),this.removeEventListener=b.removeEventListener.bind(b),this.dispatchEvent=b.dispatchEvent.bind(b),h.run=this.open=function(e){l=new WebSocket(d.url,s||[]),l.binaryType=this.binaryType,e||(b.dispatchEvent(n("connecting")),this.reconnectAttempts=0),(d.debug||a.debugAll)&&console.debug("NohupWebSocket","attempt-connect",d.url),l.onopen=function(t){h.reset(),(d.debug||a.debugAll)&&console.debug("NohupWebSocket","onopen",d.url),d.protocol=l.protocol,d.readyState=WebSocket.OPEN,d.reconnectAttempts=0;var o=n("open");o.isReconnect=e,e=!1,b.dispatchEvent(o)},l.onclose=function(e){if(l=null,f)d.readyState=WebSocket.CLOSED,b.dispatchEvent(n("close"));else{d.readyState=WebSocket.CONNECTING;var t=n("connecting");t.code=e.code,t.reason=e.reason,t.wasClean=e.wasClean,b.dispatchEvent(t),h.execute(!0)}},l.onmessage=function(e){(d.debug||a.debugAll)&&console.debug("NohupWebSocket","onmessage",d.url,e.data);var t=null;try{t=JSON.parse(e.data)}catch(o){t=e.data}("ping"==t||t&&("ping"==t.data||t.request&&"ping"==t.request.url))&&d.pong();var o=n("message");o.data=t,b.dispatchEvent(o)},l.onerror=function(e){(d.debug||a.debugAll)&&console.debug("NohupWebSocket","onerror",d.url,e),b.dispatchEvent(n("error"))}},1==this.automaticOpen&&this.open(!1),this.send=function(t){if(l){(d.debug||a.debugAll)&&console.debug("NohupWebSocket","send",d.url,t);var n=r(t),o=e.defer();return l.send(JSON.stringify(t)),d.sendMap[n]=o,o.promise}throw"INVALID_STATE_ERR : Pausing to reconnect websocket"},this.sub=function(t){var n=r(t),o=e.defer(),i=d.subMap[n];return i?i.push(o):d.subMap[n]=[o],o.promise},this.psub=function(t){var n=r(t),o=e.defer();if(n.startsWith("strict:")){n=n.substring(7);var i=d.patternMap[n];return i?i.push(o):d.patternMap[n]=[o],o.promise}},this.unsub=function(e){var t=r(e),n=d.subMap[t];return n&&(d.subMap[t]=null,delete d.subMap[t]),!0},this.unpsub=function(e){var t=r(e),n=this.patternMap[t],o=[],i=null,a=null,s=null,u=null;for(var c in n)i=c.split(":"),a=i[0],s=i[1],u=n[c],u&&a==_method&&new RegExp(s,"ig").test(_url)&&o.push(c);o.forEach(function(e){n[e]=null,delete n[e]})},this.pong=function(){this.send("pong")},this.close=function(e,t){"undefined"==typeof e&&(e=1e3),l&&l.close(e,t)},this.refresh=function(){l&&l.close()}}var s,u=!1;return t.prototype.reset=function(){this.exponential=0,u=!1},t.prototype.execute=function(){var e=function(e,t,n){var o;return u?n:(o=Math.pow(e,t),o>=n&&(o=n,u=!0),o)};return function(){var t=this,n=arguments;clearTimeout(s);var o=1e3*e(t.base,t.exponential++,t.maxWaitTime);s=setTimeout(function(){t.run(n)},o)}}(),a.prototype.onopen=function(e){},a.prototype.onclose=function(e){},a.prototype.onconnecting=function(e){},a.prototype.onmessage=function(e){var t=this,n=e.data;if(n&&n.request){var o=n.request,i=o.url,a=o.method||"GET";if(i){var s=r(o),u=t.sendMap[s],c=t.subMap[s],p=t.patternMap;u&&u.notify(n),c&&c.forEach(function(e){e.notify(n)});var l=null,d=null,f=null,b=null;for(var h in p)l=h.split(":"),d=l[0],f=l[1],b=p[h],b&&d==a&&new RegExp(f,"ig").test(i)&&b.forEach(function(e){e.notify(n)})}}},a.prototype.onerror=function(e){},a.debugAll=!1,a.CONNECTING=WebSocket.CONNECTING,a.OPEN=WebSocket.OPEN,a.CLOSING=WebSocket.CLOSING,a.CLOSED=WebSocket.CLOSED,a.getInstance=function(e,t,n){return a.instance||(a.instance=new a(e,t,n)),a.instance},a});