!function(e,t){"function"==typeof define&&define.amd?define(["q"],t):"object"==typeof exports?module.exports=t(require("q")):e.NohupWebSocket=t(e.Q)}(this,function(e){function t(e){var t={maxWaitTime:30,run:function(){this.execute()},base:2,exponential:0};e&&"object"==typeof e&&(Number(e.base)==e.base&&e.base>0&&(t.base=e.base),Number(e.exponential)==e.exponential&&e.exponential>0&&(t.exponential=e.exponential),Number(e.maxWaitTime)==e.maxWaitTime&&e.maxWaitTime>0&&(t.maxWaitTime=e.maxWaitTime),"function"==typeof e.run&&(t.run=e.run));for(var n in t)this[n]=t[n]}function n(e,t){var n=document.createEvent("CustomEvent");return n.initCustomEvent(e,!1,!1,t),n}function o(e,t){e.addEventListener("open",function(e){t.onopen(e)}),e.addEventListener("close",function(e){t.onclose(e)}),e.addEventListener("connecting",function(e){t.onconnecting(e)}),e.addEventListener("message",function(e){t.onmessage(e)}),e.addEventListener("error",function(e){t.onerror(e)})}function i(e,r,a){var c={debug:!1,automaticOpen:!0,timeoutInterval:2e3,maxReconnectAttempts:null,binaryType:"blob"};a||(a={});for(var s in c)"undefined"!=typeof a[s]?this[s]=a[s]:this[s]=c[s];this.url=e,this.reconnectAttempts=0,this.readyState=WebSocket.CONNECTING,this.protocol=null;var u,p=this,d=!1,f=document.createElement("div"),b=new t({maxWaitTime:p.maxReconnectWaitTime,base:p.reconnectBaseTime});this.sendMap={},this.subMap={},o(f,p),this.addEventListener=f.addEventListener.bind(f),this.removeEventListener=f.removeEventListener.bind(f),this.dispatchEvent=f.dispatchEvent.bind(f),b.run=this.open=function(e){u=new WebSocket(p.url,r||[]),u.binaryType=this.binaryType,e||(f.dispatchEvent(n("connecting")),this.reconnectAttempts=0),(p.debug||i.debugAll)&&console.debug("NohupWebSocket","attempt-connect",p.url),u.onopen=function(t){b.reset(),(p.debug||i.debugAll)&&console.debug("NohupWebSocket","onopen",p.url),p.protocol=u.protocol,p.readyState=WebSocket.OPEN,p.reconnectAttempts=0;var o=n("open");o.isReconnect=e,e=!1,f.dispatchEvent(o)},u.onclose=function(e){if(u=null,d)p.readyState=WebSocket.CLOSED,f.dispatchEvent(n("close"));else{p.readyState=WebSocket.CONNECTING;var t=n("connecting");t.code=e.code,t.reason=e.reason,t.wasClean=e.wasClean,f.dispatchEvent(t),b.execute(!0)}},u.onmessage=function(e){(p.debug||i.debugAll)&&console.debug("NohupWebSocket","onmessage",p.url,e.data);var t=n("message");t.data=e.data,f.dispatchEvent(t)},u.onerror=function(e){(p.debug||i.debugAll)&&console.debug("NohupWebSocket","onerror",p.url,e),f.dispatchEvent(n("error"))}},1==this.automaticOpen&&this.open(!1),this.send=function(e){if(u){(p.debug||i.debugAll)&&console.debug("NohupWebSocket","send",p.url,e);var t=JSON.stringify(e),n=Q.defer();return u.send(t),p.sendMap[t]=n,n.promise}throw"INVALID_STATE_ERR : Pausing to reconnect websocket"},this.sub=function(e){var t=JSON.stringify(e),n=Q.defer(),o=p.subMap[t];return o?o.push(n):p.subMap[t]=[n],n.promise},this.close=function(e,t){"undefined"==typeof e&&(e=1e3),u&&u.close(e,t)},this.refresh=function(){u&&u.close()}}var r,a=!1;return t.prototype.reset=function(){this.exponential=0,a=!1},t.prototype.execute=function(){var e=function(e,t,n){var o;return a?n:(o=Math.pow(e,t),o>=n&&(o=n,a=!0),o)};return function(){var t=this,n=arguments;clearTimeout(r);var o=1e3*e(t.base,t.exponential++,t.maxWaitTime);r=setTimeout(function(){t.run(n)},o)}}(),i.prototype.onopen=function(e){},i.prototype.onclose=function(e){},i.prototype.onconnecting=function(e){},i.prototype.onmessage=function(e){var t=e.data,n=this;if(t){t=JSON.parse(t);var o=JSON.stringify(t.request),i=n.sendMap[o],r=n.subMap[o];i&&i.notify(t),r&&r.forEach(function(e){e.notify(t)})}},i.prototype.onerror=function(e){},i.debugAll=!1,i.CONNECTING=WebSocket.CONNECTING,i.OPEN=WebSocket.OPEN,i.CLOSING=WebSocket.CLOSING,i.CLOSED=WebSocket.CLOSED,i.getInstance=function(e,t,n){return i.instance||(i.instance=new i(e,t,n)),i.instance},i});