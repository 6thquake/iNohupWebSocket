!function(e,n){"function"==typeof define&&define.amd?define(["q"],n):"object"==typeof exports?module.exports=n(require("q")):e.NohupWebSocket=n(e.Q)}(this,function(e){function n(e){var n={maxWaitTime:30,run:function(){this.execute()},base:2,exponential:0};e&&"object"==typeof e&&(Number(e.base)==e.base&&e.base>0&&(n.base=e.base),Number(e.exponential)==e.exponential&&e.exponential>0&&(n.exponential=e.exponential),Number(e.maxWaitTime)==e.maxWaitTime&&e.maxWaitTime>0&&(n.maxWaitTime=e.maxWaitTime),"function"==typeof e.run&&(n.run=e.run));for(var t in n)this[t]=n[t]}function t(e,n){var t=document.createEvent("CustomEvent");return t.initCustomEvent(e,!1,!1,n),t}function o(e,n){e.addEventListener("open",function(e){n.onopen(e)}),e.addEventListener("close",function(e){n.onclose(e)}),e.addEventListener("connecting",function(e){n.onconnecting(e)}),e.addEventListener("message",function(e){n.onmessage(e)}),e.addEventListener("error",function(e){n.onerror(e)})}function i(e){return"string"==typeof e||e instanceof String}function r(e){var n=e;if(!n)return null;i(n)&&(n={url:n}),n.method||(n.method="GET");var t=null;return t=n.url?["strict:",n.method.toUpperCase(),":",n.url.split("?")[0]].join(""):JSON.stringify(n)}function a(i,s,u){var c={debug:!1,automaticOpen:!0,timeoutInterval:2e3,maxReconnectAttempts:null,binaryType:"blob"};u||(u={});for(var l in c)"undefined"!=typeof u[l]?this[l]=u[l]:this[l]=c[l];this.url=i,this.reconnectAttempts=0,this.readyState=WebSocket.CONNECTING,this.protocol=null;var p,d=this,f=!1,m=document.createElement("div"),b=new n({maxWaitTime:d.maxReconnectWaitTime,base:d.reconnectBaseTime});this.sendMap={},this.subMap={},this.patternMap={},o(m,d),this.addEventListener=m.addEventListener.bind(m),this.removeEventListener=m.removeEventListener.bind(m),this.dispatchEvent=m.dispatchEvent.bind(m),b.run=this.open=function(e){p=new WebSocket(d.url,s||[]),p.binaryType=this.binaryType,e||(m.dispatchEvent(t("connecting")),this.reconnectAttempts=0),(d.debug||a.debugAll)&&console.debug("NohupWebSocket","attempt-connect",d.url),p.onopen=function(n){b.reset(),(d.debug||a.debugAll)&&console.debug("NohupWebSocket","onopen",d.url),d.protocol=p.protocol,d.readyState=WebSocket.OPEN,d.reconnectAttempts=0;var o=t("open");o.isReconnect=e,e=!1,m.dispatchEvent(o)},p.onclose=function(e){if(p=null,f)d.readyState=WebSocket.CLOSED,m.dispatchEvent(t("close"));else{d.readyState=WebSocket.CONNECTING;var n=t("connecting");n.code=e.code,n.reason=e.reason,n.wasClean=e.wasClean,m.dispatchEvent(n),b.execute(!0)}},p.onmessage=function(e){(d.debug||a.debugAll)&&console.debug("NohupWebSocket","onmessage",d.url,e.data);var n=null;try{n=JSON.parse(e.data)}catch(o){n=e.data}("ping"==n||n&&("ping"==n.data||n.request&&"ping"==n.request.url))&&d.pong();var o=t("message");o.data=n,m.dispatchEvent(o)},p.onerror=function(e){(d.debug||a.debugAll)&&console.debug("NohupWebSocket","onerror",d.url,e),m.dispatchEvent(t("error"))}},1==this.automaticOpen&&this.open(!1),this.send=function(n){if(p){(d.debug||a.debugAll)&&console.debug("NohupWebSocket","send",d.url,n);var t=r(n),o=e.defer();return p.send(JSON.stringify(n)),d.sendMap[t]=o,o.promise}throw"INVALID_STATE_ERR : Pausing to reconnect websocket"},this.sub=function(n){var t=r(n),o=e.defer(),i=d.subMap[t];return i?i.push(o):d.subMap[t]=[o],o.promise},this.psub=function(n){var t=r(n),o=e.defer();if(t.startsWith("strict:")){t=t.substring(7);var i=d.patternMap[t];return i?i.push(o):d.patternMap[t]=[o],o.promise}},this.unsub=function(e){var n=r(e),t=d.subMap[n];return t&&(d.subMap[n]=null,delete d.subMap[n]),!0},this.unpsub=function(e){var n=r(e),t=this.patternMap[n],o=[],i=null,a=null,s=null,u=null;for(var c in t)i=c.split(":"),a=i[0],s=i[1],u=t[c],u&&a==_method&&new RegExp(s,"ig").test(_url)&&o.push(c);o.forEach(function(e){t[e]=null,delete t[e]})},this.pong=function(){this.send("pong")},this.close=function(e,n){"undefined"==typeof e&&(e=1e3),p&&p.close(e,n)},this.refresh=function(){p&&p.close()}}var s,u=!1;return n.prototype.reset=function(){this.exponential=0,u=!1},n.prototype.execute=function(){var e=function(e,n,t){var o;return u?t:(o=Math.pow(e,n),o>=t&&(o=t,u=!0),o)};return function(){var n=this,t=arguments;clearTimeout(s);var o=1e3*e(n.base,n.exponential++,n.maxWaitTime);s=setTimeout(function(){n.run(t)},o)}}(),a.prototype.onopen=function(e){},a.prototype.onclose=function(e){},a.prototype.onconnecting=function(e){},a.prototype.onmessage=function(e){var n=this,t=e.data;if(t){if("NOTIFICATION"===t.type){var o=t.data;return void n.notify({title:o.title,icon:o.icon,body:o.message,dir:"auto",lang:"zh-cn",badge:o.badge,tag:o.id,image:o.image,protocol:o.protocol,renotify:"false"!=o.renotify&&!!o.renotify,requireInteraction:"false"!=o.requireInteraction&&!!o.requireInteraction,actions:o.actions||[],from:o.from||{},handler:o.handler})}if(t.request){var i=t.request,a=i.url,s=i.method||"GET";if(a){var u=r(i),c=n.sendMap[u],l=n.subMap[u],p=n.patternMap;c&&c.notify(t),l&&l.forEach(function(e){e.notify(t)});var d=null,f=null,m=null,b=null;for(var h in p)d=h.split(":"),f=d[0],m=d[1],b=p[h],b&&f==s&&new RegExp(m,"ig").test(a)&&b.forEach(function(e){e.notify(t)})}}}},a.prototype.onerror=function(e){},a.prototype.notify=function(e){a.requestPermission().then(function(n){if("denied"===n)return void console.warn("Permission wasn't granted. Allow a retry.");if("default"===n)return void console.warn("The permission request was dismissed.");var t=new Notification(e.title+": "+e.from.namespace+"/"+e.from.user+"发来的一条消息！",{icon:e.icon,iconUrl:e.icon,body:e.message||e.body,message:e.message||e.body,contextMessage:"",dir:e.dir||"auto",lang:e.lang,badge:e.badge,tag:e.tag||e.id,image:e.image,imageUrl:e.image,renotify:!!e.renotify,requireInteraction:!!e.requireInteraction,actions:e.actions});"link"===e.protocol&&(t.onclick=function(n){window.open(e.handler,"_blank"),t.close()})},function(e){console.warn(e)})},a.debugAll=!1,a.CONNECTING=WebSocket.CONNECTING,a.OPEN=WebSocket.OPEN,a.CLOSING=WebSocket.CLOSING,a.CLOSED=WebSocket.CLOSED,a.getInstance=function(e,n,t){return a.instance||(a.instance=new a(e,n,t)),a.instance},a.requestPermission=function(){var n=e.defer();return Notification?"granted"!==Notification.permission?Notification.requestPermission():(setTimeout(function(){n.resolve("granted")},10),n.promise):(setTimeout(function(){n.reject("Desktop notifications not available in your browser. Try Chromium.")},10),n.promise)},document.addEventListener("DOMContentLoaded",function(){a.requestPermission()}),a});