!function(e,t){"function"==typeof define&&define.amd?define(["q"],t):"object"==typeof exports?module.exports=t(require("q")):e.NohupWebSocket=t(e.Q)}(this,function(e){function t(e){var t={maxWaitTime:30,run:function(){this.execute()},base:2,exponential:0};e&&"object"==typeof e&&(Number(e.base)==e.base&&e.base>0&&(t.base=e.base),Number(e.exponential)==e.exponential&&e.exponential>0&&(t.exponential=e.exponential),Number(e.maxWaitTime)==e.maxWaitTime&&e.maxWaitTime>0&&(t.maxWaitTime=e.maxWaitTime),"function"==typeof e.run&&(t.run=e.run));for(var n in t)this[n]=t[n]}function n(e,t){var n=document.createEvent("CustomEvent");return n.initCustomEvent(e,!1,!1,t),n}function o(e,t){e.addEventListener("open",function(e){t.onopen(e)}),e.addEventListener("close",function(e){t.onclose(e)}),e.addEventListener("connecting",function(e){t.onconnecting(e)}),e.addEventListener("message",function(e){t.onmessage(e)}),e.addEventListener("error",function(e){t.onerror(e)})}function i(e){return"string"==typeof e||e instanceof String}function r(e){var t=e;if(!t)return null;i(t)&&(t={url:t}),t.method||(t.method="GET");var n=null;return n=t.url?["strict:",t.method.toUpperCase(),":",t.url.split("?")[0]].join(""):JSON.stringify(t)}function s(e,i,r){var a={debug:!1,automaticOpen:!0,timeoutInterval:2e3,maxReconnectAttempts:null,binaryType:"blob"};r||(r={});for(var u in a)"undefined"!=typeof r[u]?this[u]=r[u]:this[u]=a[u];this.url=e,this.reconnectAttempts=0,this.readyState=WebSocket.CONNECTING,this.protocol=null;var c=this,p=!1,l=document.createElement("div"),f=new t({maxWaitTime:c.maxReconnectWaitTime,base:c.reconnectBaseTime});this.sendMap={},this.subMap={},this.patternMap={},this.receives=[],this.notifications=[],this.billboards=[],o(l,c),this.addEventListener=l.addEventListener.bind(l),this.removeEventListener=l.removeEventListener.bind(l),this.dispatchEvent=l.dispatchEvent.bind(l),f.run=this.open=function(e){var t=new WebSocket(c.url,i||[]);t.binaryType=this.binaryType,e||(l.dispatchEvent(n("connecting")),this.reconnectAttempts=0),(c.debug||s.debugAll)&&console.debug("NohupWebSocket","attempt-connect",c.url),t.onopen=function(o){f.reset(),(c.debug||s.debugAll)&&console.debug("NohupWebSocket","onopen",c.url),c.protocol=t?t.protocol:null,c.readyState=WebSocket.OPEN,c.reconnectAttempts=0;var i=n("open");i.isReconnect=e,e=!1,l.dispatchEvent(i)},t.onclose=function(e){if(t=null,c.ws=null,p)c.readyState=WebSocket.CLOSED,l.dispatchEvent(n("close"));else{c.readyState=WebSocket.CONNECTING;var o=n("connecting");o.code=e.code,o.reason=e.reason,o.wasClean=e.wasClean,l.dispatchEvent(o),f.execute(!0)}},t.onmessage=function(e){(c.debug||s.debugAll)&&console.debug("NohupWebSocket","onmessage",c.url,e.data);var t=null;try{t=JSON.parse(e.data)}catch(o){t=e.data}("ping"==t||t&&("ping"==t.data||t.request&&"ping"==t.request.url))&&c.pong();var o=n("message");o.data=t,l.dispatchEvent(o)},t.onerror=function(e){(c.debug||s.debugAll)&&console.debug("NohupWebSocket","onerror",c.url,e),l.dispatchEvent(n("error"))},c.ws=t},1==this.automaticOpen&&this.open(!1)}var a,u=!1;return t.prototype.reset=function(){this.exponential=0,u=!1},t.prototype.execute=function(){var e=function(e,t,n){var o;return u?n:(o=Math.pow(e,t),o>=n&&(o=n,u=!0),o)};return function(){var t=this,n=arguments;clearTimeout(a);var o=1e3*e(t.base,t.exponential++,t.maxWaitTime);a=setTimeout(function(){t.run(n)},o)}}(),s.prototype.onopen=function(e){},s.prototype.onclose=function(e){},s.prototype.onconnecting=function(e){},s.prototype.onmessage=function(e){var t=e.data;if(t){if(this.receives.forEach(function(e){e.notify(t)}),"NOTIFICATION"===t.type){var n=t.data;return this.notify({title:n.title,icon:n.icon,body:n.message,dir:"auto",lang:"zh-cn",badge:n.badge,tag:n.id,image:n.image,protocol:n.protocol,renotify:"false"!=n.renotify&&!!n.renotify,requireInteraction:"false"!=n.requireInteraction&&!!n.requireInteraction,actions:n.actions||[],from:n.from||{},handler:n.handler}),void this.notifications.forEach(function(e){e.notify(t)})}if("BILLBOARD"===t.type)return void this.billboards.forEach(function(e){e.notify(t)});if(t.request){var o=t.request,i=o.url,s=o.method||"GET";if(i){var a=r(o),u=this.sendMap[a],c=this.subMap[a],p=this.patternMap;u&&u.notify(t),c&&c.forEach(function(e){e.notify(t)});var l=null,f=null,d=null,h=null;for(var m in p)l=m.split(":"),f=l[0],d=l[1],h=p[m],h&&f==s&&new RegExp(d,"ig").test(i)&&h.forEach(function(e){e.notify(t)})}}}},s.prototype.onerror=function(e){},s.prototype.notify=function(e){s.requestPermission().then(function(t){if("denied"===t)return void console.warn("Permission wasn't granted. Allow a retry.");if("default"===t)return void console.warn("The permission request was dismissed.");var n=new Notification(e.title+": "+e.from.namespace+"/"+e.from.user+"发来一条消息！",{icon:e.icon,iconUrl:e.icon,body:e.message||e.body,message:e.message||e.body,contextMessage:"",dir:e.dir||"auto",lang:e.lang,badge:e.badge,tag:e.tag||e.id,image:e.image,imageUrl:e.image,renotify:!!e.renotify,requireInteraction:!!e.requireInteraction,actions:e.actions});"link"===e.protocol&&(n.onclick=function(t){window.open(e.handler,"_blank"),n.close()})},function(e){console.warn(e)})},s.prototype.send=function(t){if(this.ws){(this.debug||s.debugAll)&&console.debug("NohupWebSocket","send",this.url,t);var n=r(t),o=e.defer();return this.ws.send(JSON.stringify(t)),this.sendMap[n]=o,o.promise}throw"INVALID_STATE_ERR : Pausing to reconnect websocket"},s.prototype.sub=function(t){var n=r(t),o=e.defer(),i=this.subMap[n];return i?i.push(o):this.subMap[n]=[o],o.promise},s.prototype.psub=function(t){var n=r(t),o=e.defer();if(n.startsWith("strict:")){n=n.substring(7);var i=this.patternMap[n];return i?i.push(o):this.patternMap[n]=[o],o.promise}},s.prototype.unsub=function(e){var t=r(e),n=this.subMap[t];return n&&(this.subMap[t]=null,delete this.subMap[t]),!0},s.prototype.unpsub=function(e){var t=r(e),n=this.patternMap[t],o=[],i=null,s=null,a=null,u=null;for(var c in n)i=c.split(":"),s=i[0],a=i[1],u=n[c],u&&s==_method&&new RegExp(a,"ig").test(_url)&&o.push(c);o.forEach(function(e){n[e]=null,delete n[e]})},s.prototype.notification=function(){var t=e.defer();return this.notifications.push(t),t.promise},s.prototype.billboard=function(){var t=e.defer();return this.billboards.push(t),t.promise},s.prototype.receive=function(){var t=e.defer();return this.receives.push(t),t.promise},s.prototype.pong=function(){this.send("pong")},s.prototype.close=function(e,t){"undefined"==typeof e&&(e=1e3),this.ws&&this.ws.close(e,t)},s.prototype.refresh=function(){this.ws&&this.ws.close()},s.debugAll=!1,s.CONNECTING=WebSocket.CONNECTING,s.OPEN=WebSocket.OPEN,s.CLOSING=WebSocket.CLOSING,s.CLOSED=WebSocket.CLOSED,s.getInstance=function(e,t,n){return s.instance||(s.instance=new s(e,t,n)),s.instance},s.requestPermission=function(){var t=e.defer();return Notification?"granted"!==Notification.permission?Notification.requestPermission():(setTimeout(function(){t.resolve("granted")},10),t.promise):(setTimeout(function(){t.reject("Desktop notifications not available in your browser. Try Chromium.")},10),t.promise)},document.addEventListener("DOMContentLoaded",function(){s.requestPermission()}),s});